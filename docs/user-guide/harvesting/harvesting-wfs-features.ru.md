# WFS GetFeature Harvesting {#getfeature_harvester}

Метаданные могут присутствовать в таблицах реляционных баз данных, которые часто используются многими организациями. Использование протокола WFS поверх реляционной базы данных позволит извлекать метаданные с помощью стандартных механизмов запроса. Этот тип сбора данных позволяет пользователю задать запрос GetFeature и занести информацию из WFS-объектов, которую можно связать или скопировать в шаблон для создания записей метаданных.

## Добавление WFS-сборщика

WFS реализует операцию запроса GetFeature, которая возвращает данные в виде объектов (обычно строк из таблиц в реляционной базе данных). GeoNetwork, действуя в качестве клиента, может прочитать ответ GetFeature и применить XLST-преобразование для создания фрагментов метаданных, которые можно связать или скопировать в предоставленный пользователем шаблон для создания записей метаданных.
Доступны следующие опции:

-   **Идентификация** - параметры собранных данных в каталоге GeoNetwork.
    -    *Имя* - Это краткое описание удаленного сайта. Оно будет показано на главной странице сбора в качестве имени для этого экземпляра CSW-харвестера.
    -    *Выбор логотипа* - Логотип будет использоваться при отображении собранных записей метаданных в результатах поиска.
    -    *Группа* - Группа, в которой разместятся собираемые метаданные.
    -    *Пользователь* - Пользователь, который будет владельцем собранных метаданных.
-   **Расписание** - Параметры расписания, согласно которым сборщик будет собирать метаданные.
    -    *Частота* - Частота (периодичность) запуска сбора метаданных харвестером.
    -    *Только один запуск* - Сборщик будет запущен только один раз, если выбран пункт.
-   **Настроить подключение** - параметры подключения к CSW-серверу.
    -    *URL сервиса* - URL CSW с параметрами GetCapabilities или без них. Например, <http://geonetwork-site.com/srv/eng/csw?service=CSW&request=GetCabilities&version=2.0.2>.
    -    *Удалённая аутентификация* - Учетные данные для базовой HTTP-аутентификации на сервере CSW (Логин и Пароль).
    -    *Запрос WFS GetFeature* - Запрос OGC WFS GetFeature, используемый для извлечения функций из WFS.

-   **Обработка ответа wfsfeatures**
    -    *Проверка записей перед импортом* - Проверка записей перед импортом.
    -    *Язык*
    -    *Стандарт метаданных*
    -    *Сохранить большой ответ на диск* -Установленный флажок означает, что ответ WFS GetFeature будет большим (например, более 10 МБ). Если этот флажок установлен, ответ GetFeature будет сохранен на диске во временном файле. Затем каждый объект будет извлечен из временного файла и использован для создания фрагментов и записей метаданных. Если флажок не установлен, ответ будет храниться в оперативной памяти.
    -    *Таблица стилей для создания фрагментов* — таблица стилей, предоставляемая пользователем, которая преобразует ответ GetFeature в документ фрагментов метаданных (формат этого документа см. ниже). Таблицы стилей существуют в каталоге WFSToFragments, который находится в каталоге преобразования выбранной выходной схемы. например. для схемы iso19139 это каталог GEONETWORK_DATA_DIR/config/schema_plugins/iso19139/convert/WFSToFragments.
    -    *Поиск дубликатов ресурсов по идентификатору ресурса* - Сравнение выполнено по элементу 'gmd:identificationInfo/*/gmd:citation/gmd:CI_Citation/gmd:identifier/*/gmd:code/gco:CharacterString'. Оно применимо только к записям по ISO19139 или профилям ISO.
    -    *Категория выходных записей метаданных*
    -    *Создать подшаблоны* - Создать подшаблоны для каждого объекта WFS.
    -    *Выберите шаблон для объединения с фрагментами*
-   **Доступность для собранных записей** - Назначение привилегий определённым группам по собранным метаданным.
    -    *Если запись существует* - Применяется только при обновлении, и если при конфликте UUID предписано задано перезаписывать записи. Если включено, привилегии не удаляются при обновлении.

## Подробнее о преобразовании ответа GetFeature во фрагменты метаданных

Внутри корневого элемента <record> может быть от нуля до множества элементов <record>. При генерации метаданных каждый элемент record приведет к созданию одного документа метаданных, в противном случае элемент <record> используется только для группировки фрагментов метаданных (например, фрагментов, сгенерированных для набора данных или объекта).

Внутри элемента <record> может быть от нуля до множества элементов <fragment> и от нуля до множества элементов <replacementGroup>. Элемент <replacementGroup> сам может содержать от нуля до множества элементов <fragment>. Порядок расположения элементов <fragment> и <replacementGroup> внутри элемента <record> или <replacementGroup> не важен.

Элементы <fragment> содержат отдельные xml-фрагменты. Содержимым <fragment> может быть любой xml-элемент из поддерживаемой схемы GeoNetwork при условии, что элемент должен содержать достаточное количество соответствующих метаданных, позволяющих идентифицировать целевую схему (т.е. различать пространства имен).

Элементы <replacementGroup> имеют значение только при генерации метаданных. Они используются для группировки фрагментов для вставки или создания ссылок в копии шаблона метаданных, используемого для генерации метаданных. Если элемент <replacementGroup> не содержит элементов <fragment>, элемент, на который ссылается копия шаблона, будет удален, в противном случае он будет заменен содержимым фрагмента.

Допустимые атрибуты этих элементов и их функция заключаются в следующем:


| Элемент            | Атрибут | Описание                                                                                                                          |
|--------------------|---------|-----------------------------------------------------------------------------------------------------------------------------------|
| <record>           | Uuid    | Uuid сгенерированной записи метаданных (необязательно - в противном случае она будет назначена сборщиком)                         |
| <fragment>         | Id      | Идентификатор элемента в шаблоне метаданных для замены/ссылки на него. Игнорируется, если фрагмент находится в группе замены.     |
|                    | Uuid    | Uuid, который будет использоваться для сгенерированного подшаблона (используется для ссылки на этот подшаблон из метаданных).     |
|                    | Title   | Заголовок фрагмента - используется в качестве заголовка xlink.                                                                    |
| <replacementGroup> | Id      | Идентификатор элемента в шаблоне метаданных, который необходимо удалить, заменить или связать с содержащимися в нем фрагментами.  |

Ниже представлены 2 примера, как собирать метаданные из функций комбайна OGC WFS, используя таблицы стилей и шаблоны, поставляемые с GeoNetwork.


## Пример сбора данных о границах подключенного геосервера (МАШИННЫЙ ПЕРЕВОД)

В этом примере предполагается, что вы установили подключенный геосервер, который поставляется с GeoNetwork. Конечным результатом этого примера будет 251 запись метаданных ISO19139, которые содержат ссылки на 1506 фрагментов (по 6 на запись), созданных из ответа GetFeature для шейп-файла boundaries в экземпляре GeoServer, поставляемом с GeoNetwork. Созданные записи содержат метаданные о странах мира.

Процедура, которой необходимо следовать, такова:

- В меню Администрирование->Конфигурация системы включите распознаватель XLink и *Сохраните* конфигурацию в базе данных.

- Добавьте программу *OGC WFS GetFeature response* для сбора данных в меню Администрирование-> Сбор данных.

- Присвойте ему *Имя* (например, gboundaries) и введите URL-адрес службы wfs из подключенного геосервера (например, <http://localhost:8080/geoserver/wfs>) в поле *URL-адрес службы*.

- Мы будем использовать простой запрос GetFeature, чтобы выбрать все страны из шейп-файла boundaries, расположенного за WFS. XML для такого запроса (который должен быть введен в текстовую область *GetFeature Query*), является:

    ``` xml
    <wfs:GetFeature service="WFS" version="1.1.0"
        xmlns:wfs="http://www.opengis.net/wfs">

      <wfs:Query typeName="gboundaries"/>

    </wfs:GetFeature>
    ```

- Выберите схему вывода - мы выберем *iso19139*, поскольку в этой схеме есть примеры таблиц стилей и шаблонов, которые нам нужны для этого примера. Обратите внимание, что после выбора этого параметра становятся видны следующие параметры, и мы предпримем следующие действия:

    - Выберите прилагаемую таблицу стилей "geoserver_boundary_fragments", чтобы извлечь фрагменты из ответа GetFeature в раскрывающемся списке "Таблица стилей", который будет использоваться для создания фрагментов. Эту таблицу стилей можно найти в "GEONETWORK_DATA_DIR/config/schema_plugins/iso19139/convert/WFSToFragments`.
    - Выберите прилагаемый шаблон "Geoserver WFS Fragments Country Boundaries Test Template" из раскрывающегося списка *, который будет использоваться для создания метаданных с использованием фрагментов*. Этот шаблон можно найти в разделе "GEONETWORK_DATA_DIR/config/schema_plugins/iso19139/templates/geoserver_fragment_tester.xml`.

- Выберите категорию для записей, созданных harvester, установите флажок "Только для одного запуска", добавьте некоторые привилегии (проще всего предоставить всем пользователям права на просмотр). На этом этапе ваша форма заявки на участие в harvester должна выглядеть так, как показано на следующем скриншоте.

- *Сохраните* форму заявки на участие в харвестере.

- Вы вернетесь в меню "Операции с харвестером", где сможете "Активировать" харвестер, а затем "Запустить" его.

На странице результатов показано, что из ответа WFS GetFeature было получено 1506 фрагментов метаданных. Они были сохранены в базе данных GeoNetwork в виде подшаблонов и связаны с шаблоном метаданных для формирования 251 новой записи метаданных.

## Пример базы данных Philosopher Deegree версии 2.x (МАШИННЫЙ ПЕРЕВОД)

В этом примере предполагается, что вы скачали версию 2.x Deegree и загрузили базу данных Philosopher example. Конечным результатом этого примера будут 7 записей метаданных ISO 19139, которые содержат ссылки на 42 фрагмента (по 6 на запись), созданные на основе ответа GetFeature от вашей установки deegree. Записи содержат метаданные о 7 известных философах.

Процедура, которой следует следовать, такова:

- В меню Администрирование->Конфигурация системы включите распознаватель XLink и *Сохраните* конфигурацию в базе данных.

- Добавьте ответ *OGC WFS GetFeature response* для харвестера из меню Администрирование-> Сбор урожая.

- - Присвойте ему *имя* (например, deegree22-philosopher-test) и введите URL-адрес вашей установки degree 2.2 в поле *Service URL*.

- Мы будем использовать простой запрос GetFeature, чтобы выбрать всех философов из базы данных в рамках WFS. XML для такого запроса (который должен быть введен в текстовую область *GetFeature Query*) является:

    ``` xml
    <wfs:GetFeature version="1.1.0" xmlns:app="http://www.deegree.org/app"
               xmlns:wfs="http://www.opengis.net/wfs">

       <!-- request all Philosopher instances -->
       <wfs:Query typeName="app:Philosopher"/>

    </wfs:GetFeature>
    ```

-   Choose an output schema - we'll choose *iso19139* as this schema has the example stylesheets and templates we need for this example. Notice that after this option is chosen the following options become visible and we'll take the following actions:

    -   Choose the supplied 'deegree2_philosopher_fragments' stylesheet to extract fragments from the GetFeature response in the *Stylesheet to use to create fragments* pull-down list. This stylesheet can be found in `GEONETWORK_DATA_DIR/config/schema_plugins/iso19139/convert/WFSToFragments`.
    -   Select the supplied 'Deegree 22 WFS Fragments Philosopher Database Test Template' template from the *Template to use to build metadata using fragments* pull-down list. This template can be found in `GEONETWORK_DATA_DIR/config/schema_plugins/iso19139/templates/deegree_fragment_tester.xml`.

-   Choose a category for the records created by the harvester, check the *One run only* box, add some privileges (simplest is to let All users have View rights). At this stage your harvester entry form should look like the following screenshot.

-   *Save* the harvester entry form.

-   You will be returned to the harvester operations menu where you can *Activate* the harvester and then *Run* it.

After the harvester has been run you should see a results screen that looks something like the following screenshot.

The results page shows that there were 42 fragments of metadata harvested from the WFS GetFeature response. They were saved to the GeoNetwork database as subtemplates and linked into the metadata template to form 7 new metadata records.
