# Сбор данных из THREDDS-каталогов {#thredds_harvester}

Каталоги [THREDDS](https://www.unidata.ucar.edu/software/tds/) описывают реестры наборов данных. Они организованы в иерархическом порядке и содержат описательную информацию и методы доступа к каждому набору данных. Обычно они каталогизируют наборы данных netCDF, но не ограничиваются только этими типами файлов. Сборщик данных может извлекать фрагменты метаданных из каталога THREDDS, позволяя пользователю связывать или копировать эти фрагменты в шаблон для создания записей метаданных.

## Adding a THREDDS Catalog Harvester

Нажмите `Собрать из` - `Каталог Thredds`, чтобы создать сборщик данных из каталогов Thredds. Доступные параметры следующие:

-   **Идентификация** - параметры собранных данных в каталоге GeoNetwork.
    -    *Имя* - Это краткое описание удаленного сайта. Оно будет показано на главной странице сбора в качестве имени для этого экземпляра CSW-харвестера.
    -    *Выбор логотипа* - Логотип будет использоваться при отображении собранных записей метаданных в результатах поиска.
    -    *Группа* - Группа, в которой разместятся собираемые метаданные.
    -    *Пользователь* - Пользователь, который будет владельцем собранных метаданных.
-   **Расписание** - Параметры расписания, согласно которым сборщик будет собирать метаданные.
    -    *Частота* - Частота (периодичность) запуска сбора метаданных харвестером.
    -    *Только один запуск* - Сборщик будет запущен только один раз, если выбран пункт.
-   **Настроить подключение** - параметры подключения к CSW-серверу.
    -    *URL сервиса* - URL CSW с параметрами GetCapabilities или без них. Например, <http://geonetwork-site.com/srv/eng/csw?service=CSW&request=GetCabilities&version=2.0.2>. 
-   **Настроить обработку ответа для thredds** - Сборщик создаёт запись метаданных на основе ответа GetCapabilities-запроса. Регулировать создание можно следующими полями.
    -    *Язык метаданных* - Параметр используется, чтобы указать язык собираемых метаданных.
    -    *Категория темы ISO* - Параметр используется, чтобы указать категорию темы ISO для служебных метаданных.
    -    *Создать метаданные ISO19119 для всех сервисов в каталоге* - Параметр используется, чтобы создать метаданные iso19119 для служб, определенных в каталоге THREDDS (например. OPeNDAP, OGC WCS, ftp) и для самого каталога THREDDS.
    -    *Выбрать схему для выходных записей метаданных*.
    -    *Название набора данных* - название набора данных. По умолчанию это URL Thredds-каталога.
    -    *Аннотация набора данных* - Аннотацию для набора данных. По умолчанию она будет: 'Thredds Dataset'
    -    *Geonetwork-категория выходных записей метаданных*
-   **Доступность для собранных записей** - Назначение привилегий определённым группам по собранным метаданным.
    -    *Если запись существует* - Применяется только при обновлении, и если при конфликте UUID предписано задано перезаписывать записи. Если включено, привилегии не удаляются при обновлении.

## Подробнее о сборе элементов метаданных THREDDS DIF (МАШИННЫЙ ПЕРЕВОД)

Каталоги THREDDS могут включать элементы из стандарта метаданных DIF. Библиотека Unidata netcdf-java предоставляет процесс записи DVD, который может создавать запись метаданных DIFF из этих элементов. В GeoNetwork есть таблица стилей DIF To ISO, позволяющая преобразовать эти записи DIF в ISO.

## Сбор метаданных "Unidata dataset discovery" (МАШИННЫЙ ПЕРЕВОД)
Описанные выше опции для *Извлечения метаданных обнаружения набора данных Unidata с использованием фрагментов* (см. <http://www.unidata.ucar.edu/software/netcdf-java/formats/DataDiscoveryAttConvention.html> для получения более подробной информации об этих соглашениях) запускают следующий процесс для каждого набора данных коллекции или атомарного набора данных в каталоге THREDDS:

1. Harvester объединяет URI каталога, сгенерированный uuid, метаданные THREDDS для набора данных (сгенерированные с использованием веб-сервиса catalog subset) и ncml для наборов данных NetCDF в единый xml-документ. Пример показан ниже.
2. Затем этот документ преобразуется с использованием указанной таблицы стилей (см. опцию "Таблица стилей" выше) для получения документа с фрагментами метаданных.
3. Затем вызывается программа сбора фрагментов метаданных для создания вложенных шаблонов и/или метаданных для каждого набора данных в соответствии с запросом

## Пример

Элементы метаданных DIF для наборов данных в каталогах THREDDS используются не так широко, как элементы метаданных, которые соответствуют соглашениям о метаданных для обнаружения наборов данных Unidata. В этом примере показано, как собирать элементы метаданных, которые соответствуют соглашениям о поиске данных Unidata (см. <http://www.unidata.ucar.edu/software/netcdf-java/formats/DataDiscoveryAttConvention.html>).

В качестве примеров того, как извлекать фрагменты метаданных из каталога THREDDS, приведены две справочные таблицы стилей. Одна из этих таблиц стилей, thredds-metadata.xsl, предназначена для генерации фрагментов метаданных iso19139 из метаданных THREDDS в соответствии с соглашениями об обнаружении наборов данных Unidata. Другая таблица стилей, netcdf-attributes.xsl, предназначена для генерации фрагментов iso19139 из наборов данных NetCDF в соответствии с соглашениями об обнаружении наборов данных Unidata. Эти таблицы стилей предназначены для использования с шаблоном "ШАБЛОН СБОРА ДАННЫХ - THREDDS - ОБНАРУЖЕНИЕ ДАННЫХ" и могут быть найдены, например, в каталоге schema "convert". для ISO19139 это `GEONETWORK_DATA_DIR/config/schema_plugins/iso19139/convert/ThreddsToFragments`.

Для использования с таблицами стилей, описанными выше для схемы метаданных iso19139, был предоставлен образец шаблона "ШАБЛОН СБОРА ДАННЫХ - THREDDS - ОБНАРУЖЕНИЕ ДАННЫХ". Этот шаблон находится в каталоге schema "шаблоны", например. для ISO19139 это `GEONETWORK_DATA_DIR/config/schema_plugins/iso19139/templates/thredds-harvester-unidata-data-discovery.xml`. Прежде чем пытаться запустить этот пример, вы должны убедиться, что этот шаблон и другие из схемы iso19139 были загружены в GeoNetwork с помощью функции "Добавить шаблоны" в меню администрирования.

Теперь мы приведем пример того, как настроить харвестер и получить метаданные THREDDS из одного из общедоступных каталогов unidata motherlode по адресу <http://motherlode.ucar.edu:8080/thredds/catalog/satellite/3.9/WEST-CONUS_4km/catalog.xml>. Если бы вы вставили этот URL-адрес в свой браузер, вы бы увидели XML-представление этого каталога THREDDS. Это документ, который считывается и преобразуется в метаданные с помощью THREDDS harvester.

В GeoNetwork зайдите в меню Администрирования, выберите Управление сбором урожая, как описано ранее. Добавьте комбайн из каталога THREDDS. Заполните форму управления сбором урожая.

Первое, на что следует обратить внимание, это то, что *URL-адрес сервиса* должен быть <http://motherlode.ucar.edu:8080/thredds/catalog/satellite/3.9/WEST-CONUS_4km/catalog.xml>. Убедитесь, что вы используете xml-версию каталога. Если вы используете html-версию, вы не сможете собрать какие-либо метаданные.

Теперь, поскольку этот каталог unidata motherload THREDDS содержит множество наборов данных файлового уровня (на самом деле, многие тысячи), мы будем собирать только метаданные коллекции. Для этого вам следует установить флажок *Создать метаданные для наборов данных коллекции* и игнорировать атомарные наборы данных.

Далее, поскольку метаданные в этом каталоге соответствуют соглашениям по обнаружению данных Unidata, мы выберем *Извлекать метаданные обнаружения набора данных Unidata, используя фрагменты*.

Далее мы проверим *Игнорировать атрибут сбора данных*. Мы делаем это потому, что наборы данных в каталоге THREDDS могут иметь атрибут, указывающий, следует ли собирать набор данных или нет. Поскольку ни один из наборов данных в этом каталоге не имеет атрибута сбора данных, мы будем игнорировать его. Если бы мы не установили этот флажок, все наборы данных были бы пропущены.

Далее мы выберем схему метаданных, в которую будут записаны собранные метаданные. Мы выберем здесь *iso19139*, потому что это схема, для которой у нас есть таблицы стилей, которые преобразуют метаданные THREDDS во фрагменты метаданных iso19139, и шаблон, в который эти фрагменты метаданных могут быть скопированы или связаны. После выбора *iso19139* появятся варианты, в которых отображаются эти таблицы стилей и шаблоны.

Первый вариант - это таблица стилей, которая будет создавать фрагменты метаданных iso19139. Поскольку нас интересуют элементы метаданных thredds в каталоге THREDDS, мы выберем *(iso19139) thredds-метаданные* (расположенные в "GEONETWORK_DATA_DIR/config/schema_plugins/iso19139/convert/ThreddsToFragments"), чтобы преобразовать эти элементы во фрагменты метаданных iso19139.

В целях этой демонстрации мы не будем *проверять *Создание подтемплат для фрагментов (xlinks\...)*. Это означает, что фрагменты метаданных, созданные с помощью таблицы стилей, будут скопированы непосредственно в шаблон метаданных. Их нельзя будет использовать повторно (например, совместно использовать между различными записями метаданных). Смотрите предыдущий раздел о фрагментах метаданных, если вы не уверены, что это означает.

Наконец, мы выберем *ШАБЛОН СБОРА ДАННЫХ - THREDDS - ОБНАРУЖЕНИЕ UNIDATA* в качестве записи метаданных шаблона, которая будет объединена с фрагментами метаданных для создания выходных записей. Этот шаблон будет загружен в GeoNetwork из `GEONETWORK_DATA_DIR/config/schema_plugins/iso19139/templates/thredds-harvester-unidata-data-discovery.xml` через функцию добавления шаблонов в интерфейсе администрирования. Этот шаблон может быть заполнен метаданными, общими для всех записей, перед запуском харвестера. Процесс, с помощью которого шаблон используется для создания записей метаданных, следующий:

1. Для каждого набора данных в каталоге THREDDS шаблон будет скопирован для создания новой записи метаданных iso19139
2. Каждый фрагмент метаданных, собранных из набора данных THREDDS, будет скопирован в новую запись метаданных iso19139 путем сопоставления идентификатора в шаблоне с идентификатором во фрагменте (это соответствие создается разработчиком шаблона и таблицы стилей).
3. Затем новая запись вставляется в каталог метаданных GeoNetwork, а содержимое записи индексируется в Lucene для поиска.

Затем вы можете заполнить оставшуюся часть формы в соответствии с тем, как часто вы хотите обновлять собранные метаданные, какие категории будут присвоены созданной записи метаданных, какой значок будет отображаться вместе с записями метаданных в результатах поиска и каковы будут привилегии для созданных записей метаданных.

Сохраните экран харвестера. Затем на экране "Управление сбором урожая" установите флажок рядом с только что созданным харвестером, *Активируйте* его, а затем * Запустите*. Через несколько секунд (в зависимости от вашего подключения к Интернету и машины) нажмите "Обновить". Если ваш сбор урожая прошел успешно, вы должны увидеть панель результатов, похожую на ту, что показана на следующем скриншоте.

Обратите внимание, что в этом каталоге THREDDS было создано 48 записей метаданных для 48 наборов данных на уровне коллекции. Каждая запись метаданных была сформирована путем дублирования шаблона метаданных и последующего копирования в него 13 фрагментов метаданных - таким образом, было собрано в общей сложности 624 фрагмента.

Ниже показан пример одной из записей метаданных на уровне коллекции, созданных харвестером в этом примере и отрисованных GeoNetwork.